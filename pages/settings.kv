#:kivy 2.1.0
#:import dp kivy.metrics.dp
#:import ThemeSelectButton widgets.select_button.ThemeSelectButton
#:import LanguageSelectButton widgets.select_button.LanguageSelectButton

<SettingsScreen>:
    name: "settings"
    
    BoxLayout:
        orientation: 'vertical'
        padding: dp(16)
        spacing: dp(16)

        # Верхний блок: Тема и Язык
        BoxLayout:
            orientation: 'horizontal'
            spacing: dp(16)
            size_hint_y: None
            height: dp(240)
            
            # Настройки темы
            OverlayCard:
                size_hint_x: 0.6
                padding: dp(16)
                
                BoxLayout:
                    orientation: 'vertical'
                    spacing: dp(16)
                    
                    # Заголовок темы
                    Label:
                        id: theme_section_label
                        text: "Theme Settings"
                        font_size: '20sp'
                        font_name: app.theme_manager.get_font("title") if app.theme_manager else ""
                        color: app.theme_manager.get_rgba("primary") if app.theme_manager else [1,1,1,1]
                        size_hint_y: None
                        height: dp(32)
                        halign: 'center'
                        valign: 'middle'
                        text_size: self.size
                    
                    # Выбор темы
                    BoxLayout:
                        orientation: 'horizontal'
                        spacing: dp(16)
                        size_hint_y: None
                        height: dp(56)
                        
                        Label:
                            id: theme_label
                            text: "Theme:"
                            font_size: '16sp'
                            font_name: app.theme_manager.get_font("main") if app.theme_manager else ""
                            color: app.theme_manager.get_rgba("text") if app.theme_manager else [1,1,1,1]
                            size_hint_x: 0.35
                            halign: 'right'
                            valign: 'middle'
                            text_size: self.size
                        
                        ThemeSelectButton:
                            id: theme_button
                            font_size: '16sp'
                            font_name: app.theme_manager.get_font("main") if app.theme_manager else ""
                            color: app.theme_manager.get_rgba("text") if app.theme_manager else [1,1,1,1]
                            background_normal: app.theme_manager.get_image("button_bg") if app.theme_manager else ""
                            background_down: app.theme_manager.get_image("button_bg_active") if app.theme_manager else ""
                            size_hint_x: 0.65
                            disabled: not root.theme_selector_enabled
                            opacity: 1.0 if root.theme_selector_enabled else 0.5
                    
                    # Выбор режима (light/dark)
                    BoxLayout:
                        orientation: 'horizontal'
                        spacing: dp(16)
                        size_hint_y: None
                        height: dp(56)
                        
                        Label:
                            id: variant_label
                            text: "Mode:"
                            font_size: '16sp'
                            font_name: app.theme_manager.get_font("main") if app.theme_manager else ""
                            color: app.theme_manager.get_rgba("text") if app.theme_manager else [1,1,1,1]
                            size_hint_x: 0.35
                            halign: 'right'
                            valign: 'middle'
                            text_size: self.size
                        
                        ThemeSelectButton:
                            id: variant_button
                            popup_title: "Select Mode"
                            font_size: '16sp'
                            font_name: app.theme_manager.get_font("main") if app.theme_manager else ""
                            color: app.theme_manager.get_rgba("text") if app.theme_manager else [1,1,1,1]
                            background_normal: app.theme_manager.get_image("button_bg") if app.theme_manager else ""
                            background_down: app.theme_manager.get_image("button_bg_active") if app.theme_manager else ""
                            size_hint_x: 0.65
                    
                    # Заполнитель для выравнивания
                    Widget:
            
            # Настройки языка
            OverlayCard:
                size_hint_x: 0.4
                padding: dp(16)
                
                BoxLayout:
                    orientation: 'vertical'
                    spacing: dp(16)
                    
                    # Заголовок локализации
                    Label:
                        id: language_section_label
                        text: "Localization"
                        font_size: '20sp'
                        font_name: app.theme_manager.get_font("title") if app.theme_manager else ""
                        color: app.theme_manager.get_rgba("primary") if app.theme_manager else [1,1,1,1]
                        size_hint_y: None
                        height: dp(32)
                        halign: 'center'
                        valign: 'middle'
                        text_size: self.size
                    
                    # Выбор языка
                    BoxLayout:
                        orientation: 'horizontal'
                        spacing: dp(16)
                        size_hint_y: None
                        height: dp(56)
                        
                        Label:
                            id: language_label
                            text: "Language:"
                            font_size: '16sp'
                            font_name: app.theme_manager.get_font("main") if app.theme_manager else ""
                            color: app.theme_manager.get_rgba("text") if app.theme_manager else [1,1,1,1]
                            size_hint_x: 0.4
                            halign: 'right'
                            valign: 'middle'
                            text_size: self.size
                        
                        LanguageSelectButton:
                            id: language_button
                            font_size: '16sp'
                            font_name: app.theme_manager.get_font("main") if app.theme_manager else ""
                            color: app.theme_manager.get_rgba("text") if app.theme_manager else [1,1,1,1]
                            background_normal: app.theme_manager.get_image("button_bg") if app.theme_manager else ""
                            background_down: app.theme_manager.get_image("button_bg_active") if app.theme_manager else ""
                            size_hint_x: 0.6
                    
                    # Заполнитель для выравнивания
                    Widget:

        # Средний блок: Пользователь, Автотема и Громкость
        BoxLayout:
            orientation: 'horizontal'
            spacing: dp(16)
            size_hint_y: None
            height: dp(200)
            
            # Настройки пользователя
            OverlayCard:
                size_hint_x: 0.33
                padding: dp(16)
                
                BoxLayout:
                    orientation: 'vertical'
                    spacing: dp(16)
                    
                    # Заголовок пользователя
                    Label:
                        id: user_section_label
                        text: "User Profile"
                        font_size: '18sp'
                        font_name: app.theme_manager.get_font("title") if app.theme_manager else ""
                        color: app.theme_manager.get_rgba("primary") if app.theme_manager else [1,1,1,1]
                        size_hint_y: None
                        height: dp(32)
                        halign: 'center'
                        valign: 'middle'
                        text_size: self.size
                    
                    # Имя пользователя
                    BoxLayout:
                        orientation: 'horizontal'
                        spacing: dp(8)
                        size_hint_y: None
                        height: dp(40)
                        
                        Label:
                            text: "Name:"
                            font_size: '14sp'
                            font_name: app.theme_manager.get_font("main") if app.theme_manager else ""
                            color: app.theme_manager.get_rgba("text") if app.theme_manager else [1,1,1,1]
                            size_hint_x: 0.4
                            halign: 'right'
                            valign: 'middle'
                            text_size: self.size
                        
                        TextInput:
                            id: username_input
                            text: root.username
                            font_size: '14sp'
                            font_name: app.theme_manager.get_font("main") if app.theme_manager else ""
                            foreground_color: app.theme_manager.get_rgba("text") if app.theme_manager else [1,1,1,1]
                            background_color: app.theme_manager.get_rgba("background") if app.theme_manager else [0.2,0.2,0.2,1]
                            size_hint_x: 0.6
                            multiline: False
                            on_text: root.on_username_change(self, self.text)
                    
                    # День рождения
                    BoxLayout:
                        orientation: 'horizontal'
                        spacing: dp(8)
                        size_hint_y: None
                        height: dp(40)
                        
                        Label:
                            text: "Birth:"
                            font_size: '14sp'
                            font_name: app.theme_manager.get_font("main") if app.theme_manager else ""
                            color: app.theme_manager.get_rgba("text") if app.theme_manager else [1,1,1,1]
                            size_hint_x: 0.4
                            halign: 'right'
                            valign: 'middle'
                            text_size: self.size
                        
                        BoxLayout:
                            orientation: 'horizontal'
                            spacing: dp(4)
                            size_hint_x: 0.6
                            
                            TextInput:
                                id: birth_day_input
                                text: root.birth_day
                                font_size: '12sp'
                                font_name: app.theme_manager.get_font("main") if app.theme_manager else ""
                                foreground_color: app.theme_manager.get_rgba("text") if app.theme_manager else [1,1,1,1]
                                background_color: app.theme_manager.get_rgba("background") if app.theme_manager else [0.2,0.2,0.2,1]
                                size_hint_x: 0.3
                                multiline: False
                                input_filter: 'int'
                                hint_text: "DD"
                                on_text: root.on_birth_day_change(self, self.text)
                            
                            TextInput:
                                id: birth_month_input
                                text: root.birth_month
                                font_size: '12sp'
                                font_name: app.theme_manager.get_font("main") if app.theme_manager else ""
                                foreground_color: app.theme_manager.get_rgba("text") if app.theme_manager else [1,1,1,1]
                                background_color: app.theme_manager.get_rgba("background") if app.theme_manager else [0.2,0.2,0.2,1]
                                size_hint_x: 0.3
                                multiline: False
                                input_filter: 'int'
                                hint_text: "MM"
                                on_text: root.on_birth_month_change(self, self.text)

                            TextInput:
                                id: birth_year_input
                                text: root.birth_year
                                font_size: '12sp'
                                font_name: app.theme_manager.get_font("main") if app.theme_manager else ""
                                foreground_color: app.theme_manager.get_rgba("text") if app.theme_manager else [1,1,1,1]
                                background_color: app.theme_manager.get_rgba("background") if app.theme_manager else [0.2,0.2,0.2,1]
                                size_hint_x: 0.4
                                multiline: False
                                input_filter: 'int'
                                hint_text: "YYYY"
                                on_text: root.on_birth_year_change(self, self.text)
                    
                    # Заполнитель
                    Widget:
            
            # Настройки автотемы
            OverlayCard:
                size_hint_x: 0.33
                padding: dp(16)
                
                BoxLayout:
                    orientation: 'vertical'
                    spacing: dp(16)
                    
                    # Заголовок автотемы
                    Label:
                        id: auto_theme_section_label
                        text: "Auto Theme"
                        font_size: '18sp'
                        font_name: app.theme_manager.get_font("title") if app.theme_manager else ""
                        color: app.theme_manager.get_rgba("primary") if app.theme_manager else [1,1,1,1]
                        size_hint_y: None
                        height: dp(32)
                        halign: 'center'
                        valign: 'middle'
                        text_size: self.size
                    
                    # Переключатель автотемы
                    BoxLayout:
                        orientation: 'horizontal'
                        spacing: dp(8)
                        size_hint_y: None
                        height: dp(40)
                        
                        Label:
                            text: "Auto:"
                            font_size: '14sp'
                            font_name: app.theme_manager.get_font("main") if app.theme_manager else ""
                            color: app.theme_manager.get_rgba("text") if app.theme_manager else [1,1,1,1]
                            size_hint_x: 0.4
                            halign: 'right'
                            valign: 'middle'
                            text_size: self.size
                        
                        ToggleButton:
                            id: auto_theme_button
                            text: "ON" if root.auto_theme_enabled else "OFF"
                            font_size: '14sp'
                            font_name: app.theme_manager.get_font("main") if app.theme_manager else ""
                            color: (app.theme_manager.get_rgba("primary") if root.auto_theme_enabled else app.theme_manager.get_rgba("text_secondary")) if app.theme_manager else ([1,1,1,1] if root.auto_theme_enabled else [0.7,0.7,0.7,1])
                            background_normal: app.theme_manager.get_image("button_bg") if app.theme_manager else ""
                            background_down: app.theme_manager.get_image("button_bg_active") if app.theme_manager else ""
                            size_hint_x: 0.6
                            disabled: not root.light_sensor_available
                            on_release: root.toggle_auto_theme()
                    
                    # Порог датчика
                    BoxLayout:
                        orientation: 'horizontal'
                        spacing: dp(8)
                        size_hint_y: None
                        height: dp(40)
                        
                        Label:
                            text: "Threshold:"
                            font_size: '14sp'
                            font_name: app.theme_manager.get_font("main") if app.theme_manager else ""
                            color: app.theme_manager.get_rgba("text") if app.theme_manager else [1,1,1,1]
                            size_hint_x: 0.6
                            halign: 'right'
                            valign: 'middle'
                            text_size: self.size
                        
                        Label:
                            id: threshold_value_label
                            text: f"{root.light_sensor_threshold}"
                            font_size: '14sp'
                            font_name: app.theme_manager.get_font("main") if app.theme_manager else ""
                            color: app.theme_manager.get_rgba("primary") if app.theme_manager else [1,1,1,1]
                            size_hint_x: 0.4
                            halign: 'center'
                            valign: 'middle'
                            text_size: self.size
                    
                    # Статус датчика
                    Label:
                        id: sensor_status_label
                        text: f"Status: {root.current_light_status}"
                        font_size: '12sp'
                        font_name: app.theme_manager.get_font("main") if app.theme_manager else ""
                        color: app.theme_manager.get_rgba("text_secondary") if app.theme_manager else [0.7,0.7,0.7,1]
                        size_hint_y: None
                        height: dp(24)
                        halign: 'center'
                        valign: 'middle'
                        text_size: self.size
            
            # Управление громкостью
            OverlayCard:
                size_hint_x: 0.34
                padding: dp(16)
                
                BoxLayout:
                    orientation: 'vertical'
                    spacing: dp(16)
                    
                    # Заголовок громкости
                    Label:
                        id: volume_section_label
                        text: "Volume Control"
                        font_size: '18sp'
                        font_name: app.theme_manager.get_font("title") if app.theme_manager else ""
                        color: app.theme_manager.get_rgba("primary") if app.theme_manager else [1,1,1,1]
                        size_hint_y: None
                        height: dp(32)
                        halign: 'center'
                        valign: 'middle'
                        text_size: self.size
                    
                    # Текущее значение громкости
                    Label:
                        id: volume_value_label
                        text: f"{root.current_volume}%"
                        font_size: '24sp'
                        font_name: app.theme_manager.get_font("title") if app.theme_manager else ""
                        color: app.theme_manager.get_rgba("primary") if app.theme_manager else [1,1,1,1]
                        size_hint_y: None
                        height: dp(40)
                        halign: 'center'
                        valign: 'middle'
                        text_size: self.size
                    
                    # Кнопки управления громкостью
                    BoxLayout:
                        orientation: 'horizontal'
                        spacing: dp(16)
                        size_hint_y: None
                        height: dp(48)
                        
                        Button:
                            id: volume_down_button
                            text: "−"
                            font_size: '20sp'
                            font_name: app.theme_manager.get_font("main") if app.theme_manager else ""
                            color: app.theme_manager.get_rgba("text") if app.theme_manager else [1,1,1,1]
                            background_normal: app.theme_manager.get_image("button_bg") if app.theme_manager else ""
                            background_down: app.theme_manager.get_image("button_bg_active") if app.theme_manager else ""
                            disabled: not root.volume_service_available
                            on_release: root.volume_down()
                        
                        Button:
                            id: volume_up_button
                            text: "+"
                            font_size: '20sp'
                            font_name: app.theme_manager.get_font("main") if app.theme_manager else ""
                            color: app.theme_manager.get_rgba("text") if app.theme_manager else [1,1,1,1]
                            background_normal: app.theme_manager.get_image("button_bg") if app.theme_manager else ""
                            background_down: app.theme_manager.get_image("button_bg_active") if app.theme_manager else ""
                            disabled: not root.volume_service_available
                            on_release: root.volume_up()
                    
                    # Заполнитель
                    Widget:

        # Нижний блок: Кнопка сохранения
        BoxLayout:
            orientation: 'horizontal'
            spacing: dp(16)
            size_hint_y: None
            height: dp(64)
            
            # Заполнитель слева
            Widget:
                size_hint_x: 0.3
            
            # Кнопка сохранения
            Button:
                id: save_button
                text: "Save Settings"
                font_size: '18sp'
                font_name: app.theme_manager.get_font("title") if app.theme_manager else ""
                color: app.theme_manager.get_rgba("text") if app.theme_manager else [1,1,1,1]
                background_normal: app.theme_manager.get_image("button_bg") if app.theme_manager else ""
                background_down: app.theme_manager.get_image("button_bg_active") if app.theme_manager else ""
                size_hint_x: 0.4
                on_release: root.save_all_settings()
            
            # Заполнитель справа
            Widget:
                size_hint_x: 0.3